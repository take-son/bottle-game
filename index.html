<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- モバイル対応 -->
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>格闘キャラ 対戦テスト（ロード待ち＋CSS修正）</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #222; overflow: hidden;
    }
    /* canvas は幅100% にして、高さは自動で */
    #gameCanvas {
      display: block;
      margin: 0 auto;
      background: #555;
      width: 100%;
      height: auto;
      max-height: calc(100vh - 80px);
    }
    /* ボタンは画面下に固定 */
    #controls {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 80px;
      background: rgba(0,0,0,0.3);
      text-align: center;
      line-height: 80px;
    }
    .btn {
      background: #888;
      border: none;
      color: white;
      font-size: 24px;
      margin: 0 10px;
      padding: 15px 25px;
      border-radius: 10px;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="320" height="260"></canvas>
  <div id="controls">
    <button class="btn" id="leftBtn">←</button>
    <button class="btn" id="punchBtn">パンチ</button>
    <button class="btn" id="rightBtn">→</button>
  </div>

  <script>
  // ── 1) まずイメージをロード ─────────────────────────
  const base64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABHklEQVRYhe3V0Q2DMBBG4QsIgiIIhCgIhChCkRACI4ggMhChCIYi+MbyZTKzZ9T0S2zM7sz+Hc/FjlNGq1Wq9WCk6jPMAgAAAAAAAAAAAICrS/h1Wi9bDaEkAsgMcX3R38S+nNMI7iMYWZfXZbRuCBejqN40AOkcArh+OpkCMBdAx+5MBqAKwLIF1u0c4Tns0gImUw2PaY19Mmr7xTzshUjH9mplyYOuZMePC8Kk4bpD+ICvNPDzBzDHzWlNUpNu39RGX1/4BgABAPdOpW8DaP47/Q/vvHEAAAAASUVORK5CYII=';

  const playerIdle  = new Image();
  const playerPunch = new Image();
  const enemyIdle   = new Image();
  const enemyPunch  = new Image();
  let imagesLoaded = 0;
  [playerIdle, playerPunch, enemyIdle, enemyPunch].forEach(img => {
    img.src = base64;
    img.onload = () => {
      if (++imagesLoaded === 4) startGame();
    };
  });

  // ── 2) 全部ロードできたらゲーム開始 ─────────────────
  function startGame() {
    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d');

    let playerX = 50,  playerY = cvs.height/2 - 16;
    let enemyX  = cvs.width - 50 - 32, enemyY = cvs.height/2 - 16;
    const speed = 2;
    let isPunching = false, enemyPunching = false;
    let playerFlash = false, enemyFlash = false;
    let gameOver = false;
    const maxLife = 100;
    let playerLife = maxLife, enemyLife = maxLife;

    // 敵AIパンチ
    setInterval(() => {
      if (!enemyPunching && !gameOver && Math.random() < 0.5) {
        enemyPunching = true;
        setTimeout(() => enemyPunching = false, 300);
      }
    }, 1000);

    // 描画ループ
    function draw() {
      ctx.clearRect(0, 0, cvs.width, cvs.height);

      // ライフゲージ
      const barW = 100, barH = 10;
      ctx.fillStyle = '#444';
      ctx.fillRect(10,10,barW,barH);
      ctx.fillStyle = 'lime';
      ctx.fillRect(10,10,barW*(playerLife/maxLife),barH);
      ctx.fillStyle = '#444';
      ctx.fillRect(cvs.width-10-barW,10,barW,barH);
      ctx.fillStyle = 'lime';
      ctx.fillRect(cvs.width-10-barW + barW*(1-enemyLife/maxLife),10,barW*(enemyLife/maxLife),barH);

      // 勝敗
      if (playerLife<=0 || enemyLife<=0) {
        gameOver = true;
        ctx.fillStyle = '#fff';
        ctx.font = '24px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(enemyLife<=0?'勝利！':'敗北…', cvs.width/2, cvs.height/2);
        return;
      }

      // プレイヤー描画
      if (playerFlash) {
        ctx.fillStyle = 'rgba(255,0,0,0.5)';
        ctx.fillRect(playerX,playerY,32,32);
      }
      ctx.drawImage(isPunching?playerPunch:playerIdle, playerX, playerY, 32, 32);

      // 敵描画（反転）
      if (enemyFlash) {
        ctx.fillStyle = 'rgba(255,0,0,0.5)';
        ctx.fillRect(enemyX,enemyY,32,32);
      }
      ctx.save();
      ctx.translate(enemyX+32,0);
      ctx.scale(-1,1);
      ctx.drawImage(enemyPunching?enemyPunch:enemyIdle, 0, enemyY, 32, 32);
      ctx.restore();

      // 当たり判定
      if (isPunching && !enemyFlash &&
          playerX+32>enemyX+8 && playerX<enemyX+32) {
        enemyFlash = true;
        enemyLife = Math.max(0, enemyLife-10);
        setTimeout(()=>enemyFlash=false,200);
      }
      if (enemyPunching && !playerFlash &&
          enemyX<playerX+24 && enemyX+32>playerX) {
        playerFlash = true;
        playerLife = Math.max(0, playerLife-10);
        setTimeout(()=>playerFlash=false,200);
      }

      requestAnimationFrame(draw);
    }
    draw();

    // 操作
    function punch() {
      if (isPunching||gameOver) return;
      isPunching = true;
      setTimeout(()=>isPunching=false,300);
    }
    document.addEventListener('keydown', e=>{
      if (gameOver) return;
      if (e.key==='ArrowLeft')  playerX = Math.max(0, playerX-speed);
      if (e.key==='ArrowRight') playerX = Math.min(cvs.width-32, playerX+speed);
      if (e.key===' ') punch();
    });
    document.getElementById('leftBtn').addEventListener('touchstart', ()=>{
      if (!gameOver) playerX = Math.max(0, playerX-speed*5);
    });
    document.getElementById('rightBtn').addEventListener('touchstart', ()=>{
      if (!gameOver) playerX = Math.min(cvs.width-32, playerX+speed*5);
    });
    document.getElementById('punchBtn').addEventListener('touchstart', punch);
  }
  </script>
</body>
</html>
